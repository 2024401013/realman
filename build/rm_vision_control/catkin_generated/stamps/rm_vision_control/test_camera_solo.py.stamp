#!/usr/bin/env python
# test_camera_solo.py - 单独测试相机处理模块
import rospy
import cv2
import numpy as np
from sensor_msgs.msg import Image, CameraInfo
from cv_bridge import CvBridge

class CameraSoloTest:
    def __init__(self):
        rospy.init_node('camera_solo_test')
        self.bridge = CvBridge()
        
        # 存储数据
        self.color_image = None
        self.depth_image = None
        self.camera_info = None
        
        # 订阅话题
        rospy.Subscriber('/camera/color/image_raw', Image, self.color_callback)
        rospy.Subscriber('/camera/aligned_depth_to_color/image_raw', Image, self.depth_callback)
        rospy.Subscriber('/camera/color/camera_info', CameraInfo, self.info_callback)
        
        # 测试结果
        self.test_results = {}
        
        rospy.loginfo("Camera Solo Test initialized")
    
    def color_callback(self, msg):
        """颜色图像回调"""
        try:
            self.color_image = self.bridge.imgmsg_to_cv2(msg, 'bgr8')
        except Exception as e:
            rospy.logerr(f"Color image error: {e}")
    
    def depth_callback(self, msg):
        """深度图像回调"""
        try:
            self.depth_image = self.bridge.imgmsg_to_cv2(msg, 'passthrough')
        except Exception as e:
            rospy.logerr(f"Depth image error: {e}")
    
    def info_callback(self, msg):
        """相机信息回调"""
        self.camera_info = msg
    
    def test_image_reception(self, timeout=10.0):
        """测试图像接收"""
        rospy.loginfo("=== Testing Image Reception ===")
        
        start_time = rospy.Time.now()
        while (rospy.Time.now() - start_time).to_sec() < timeout:
            if self.color_image is not None and self.depth_image is not None:
                rospy.loginfo("✓ Both color and depth images received")
                
                # 检查图像尺寸
                color_shape = self.color_image.shape
                depth_shape = self.depth_image.shape
                
                rospy.loginfo(f"Color image shape: {color_shape}")
                rospy.loginfo(f"Depth image shape: {depth_shape}")
                
                # 检查深度图像类型
                depth_dtype = self.depth_image.dtype
                rospy.loginfo(f"Depth image dtype: {depth_dtype}")
                
                self.test_results['image_reception'] = True
                return True
            
            rospy.sleep(0.1)
        
        rospy.logwarn("✗ Timeout waiting for images")
        self.test_results['image_reception'] = False
        return False
    
    def test_image_quality(self):
        """测试图像质量"""
        rospy.loginfo("=== Testing Image Quality ===")
        
        if self.color_image is None:
            rospy.logwarn("✗ No color image available")
            self.test_results['image_quality'] = False
            return False
        
        # 检查颜色图像质量
        color_mean = np.mean(self.color_image)
        color_std = np.std(self.color_image)
        
        rospy.loginfo(f"Color image - Mean: {color_mean:.1f}, Std: {color_std:.1f}")
        
        # 简单的质量检查
        if color_mean < 10 or color_mean > 245:
            rospy.logwarn("✗ Color image may be under/over exposed")
            self.test_results['image_quality'] = False
            return False
        
        # 检查深度图像
        if self.depth_image is not None:
            valid_depth = self.depth_image[self.depth_image > 0]
            if len(valid_depth) > 0:
                depth_mean = np.mean(valid_depth)
                rospy.loginfo(f"Valid depth mean: {depth_mean:.1f} mm")
        
        self.test_results['image_quality'] = True
        return True
    
    def test_camera_info(self):
        """测试相机内参"""
        rospy.loginfo("=== Testing Camera Info ===")
        
        if self.camera_info is None:
            rospy.logwarn("✗ No camera info received")
            self.test_results['camera_info'] = False
            return False
        
        # 打印内参
        rospy.loginfo(f"Camera matrix K: {self.camera_info.K}")
        rospy.loginfo(f"Distortion coefficients D: {self.camera_info.D}")
        rospy.loginfo(f"Image width: {self.camera_info.width}, height: {self.camera_info.height}")
        
        # 基本检查
        if self.camera_info.width == 0 or self.camera_info.height == 0:
            rospy.logwarn("✗ Invalid image dimensions")
            self.test_results['camera_info'] = False
            return False
        
        self.test_results['camera_info'] = True
        return True
    
    def test_visualization(self):
        """简单的可视化测试"""
        rospy.loginfo("=== Testing Visualization ===")
        
        if self.color_image is None:
            rospy.logwarn("✗ No image for visualization")
            self.test_results['visualization'] = False
            return False
        
        try:
            # 创建显示窗口
            cv2.imshow('Color Image Test', self.color_image)
            cv2.waitKey(2000)  # 显示2秒
            
            # 显示深度图
            if self.depth_image is not None:
                depth_colormap = cv2.applyColorMap(
                    cv2.convertScaleAbs(self.depth_image, alpha=0.03),
                    cv2.COLORMAP_JET
                )
                cv2.imshow('Depth Image Test', depth_colormap)
                cv2.waitKey(2000)
            
            cv2.destroyAllWindows()
            rospy.loginfo("✓ Visualization test passed")
            self.test_results['visualization'] = True
            return True
            
        except Exception as e:
            rospy.logerr(f"✗ Visualization error: {e}")
            self.test_results['visualization'] = False
            return False
    
    def run_tests(self):
        """运行所有测试"""
        rospy.loginfo("Waiting for camera data...")
        rospy.sleep(2.0)
        
        tests = [
            ("Image Reception", self.test_image_reception),
            ("Image Quality", self.test_image_quality),
            ("Camera Info", self.test_camera_info),
            ("Visualization", self.test_visualization)
        ]
        
        all_passed = True
        for test_name, test_func in tests:
            rospy.loginfo(f"\n{'='*50}")
            try:
                result = test_func()
                rospy.loginfo(f"{test_name}: {'✓ PASS' if result else '✗ FAIL'}")
                all_passed = all_passed and result
                rospy.sleep(1.0)
            except Exception as e:
                rospy.logerr(f"{test_name} error: {e}")
                all_passed = False
        
        # 输出总结
        rospy.loginfo(f"\n{'='*50}")
        rospy.loginfo("TEST SUMMARY:")
        for test_name, passed in self.test_results.items():
            status = '✓ PASS' if passed else '✗ FAIL'
            rospy.loginfo(f"  {test_name}: {status}")
        
        return all_passed

if __name__ == '__main__':
    try:
        tester = CameraSoloTest()
        success = tester.run_tests()
        exit(0 if success else 1)
    except rospy.ROSInterruptException:
        pass